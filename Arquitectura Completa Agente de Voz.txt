Arquitectura Completa: Agente de Voz ‚Üî Twilio
üì¶ Las 4 Piezas del Sistema
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Tel√©fono del   ‚îÇ ‚îÄ‚îÄ1‚îÄ‚îÄ>  ‚îÇ     Twilio      ‚îÇ ‚îÄ‚îÄ2‚îÄ‚îÄ>  ‚îÇ  CallCenteria   ‚îÇ
‚îÇ    Usuario      ‚îÇ         ‚îÇ    (Cloud)      ‚îÇ         ‚îÇ  (Backend 4000) ‚îÇ
‚îÇ                 ‚îÇ <‚îÄ‚îÄ5‚îÄ‚îÄ  ‚îÇ                 ‚îÇ <‚îÄ‚îÄ4‚îÄ‚îÄ  ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ                          ‚îÇ
                                    ‚îÇ                          ‚îÇ 3
                                    ‚îÇ                          ‚ñº
                                    ‚îÇ                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ                   ‚îÇ  Gemini / OpenAI‚îÇ
                                    ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
üóÑÔ∏è Base de Datos: D√≥nde Vive Toda la Config
Todo est√° almacenado en MySQL, en dos tablas clave:

Tabla configuracion_canales ‚Äî Las credenciales de Twilio
Esta tabla tiene una fila por organizaci√≥n. Guarda absolutamente todo lo necesario para conectar con Twilio y con la IA:

Columna DB	Qu√© es	Desde d√≥nde se configura
sms_api_key	Twilio Account SID (ACxxx...)	Settings de la app
sms_api_secret	Twilio Auth Token	Settings de la app
sms_from_number	N√∫mero de Twilio (ej: +15551234567)	Settings de la app
gemini_api_key	API Key de Gemini	Settings de la app
openai_api_key	API Key de OpenAI	Settings de la app
twilio_default_agent_id	ID del agente IA de fallback	Panel de Twilio en app
sms_provider	Se fija en "twilio" autom√°ticamente	Al guardar Account SID
Nota importante: No hay credenciales de Twilio en el archivo .env. El 

.env.example
 solo tiene NODE_ENV, PORT, DATABASE_*, JWT_SECRET, CORS_ORIGIN y BASE_URL. Las credenciales de Twilio van √∫nicamente en la base de datos, ingresadas desde la UI de Settings.

Tabla agentes_ia ‚Äî La personalidad del agente de voz
Columna	Qu√© es
nombre	Nombre del agente (ej: "Asistente de Ventas")
tipo	'voz', 'texto' o 'hibrido'
prompt_sistema	Las instrucciones que recibe la IA
greeting_message	Lo primero que dice al contestar
telefono_asignado	El n√∫mero de Twilio asignado a este agente
telefono_activo	1 = activo, 0 = inactivo (no contesta)
estado	1 = existe, 0 = desactivado
personalidad	Descripci√≥n usada como fallback del prompt
Tabla twilio_calls ‚Äî Registro de cada llamada
Guarda el historial: call_sid, from_number, to_number, direction (inbound/outbound), status, transcript (conversaci√≥n completa), agent_id, duration, recording_url.

üåê La Variable BASE_URL: El Puente Cr√≠tico
En el .env, existe esta variable:

BASE_URL=https://tu-dominio.com
Esta es la URL p√∫blica de tu servidor. Es absolutamente cr√≠tica porque Twilio est√° en la nube de Internet y necesita saber a qu√© URL llamar con los webhooks. El backend la usa en tres lugares del c√≥digo:

GET /api/twilio/config ‚Äî Cuando la UI pide la configuraci√≥n, construye las URLs de webhook as√≠:

typescript
const baseUrl = process.env.BASE_URL || 'https://secretaria.click';
webhook_url: `${baseUrl}/api/twilio/voice`
status_url:  `${baseUrl}/api/twilio/status`
POST /api/twilio/call ‚Äî Al hacer llamadas salientes, le dice a Twilio qu√© URL usar para el TwiML:

typescript
formData.append('Url', `${baseUrl}/api/twilio/voice/outbound?agent_id=...`)
POST /api/agentes-ia/:id/test-call ‚Äî Lo mismo para llamadas de prueba.

En producci√≥n BASE_URL=https://secretaria.click ‚Äî En desarrollo local necesitas ngrok o cloudflared.

üîÅ Flujo Completo Llamada ENTRANTE (paso a paso)
PASO 1: Usuario llama ‚Üí Twilio recibe
Alguien llama al n√∫mero de Twilio (ej: +15551234567). Twilio hace un POST autom√°tico al webhook:

POST https://secretaria.click/api/twilio/voice
Content-Type: application/x-www-form-urlencoded
Called=+15551234567&Caller=+15559876543&CallSid=CA123abc&CallStatus=ringing
PASO 2: Backend identifica la organizaci√≥n y el agente
El handler en [

twilio.routes.ts
 l√≠nea 261](file:///c:/callcenteria/backend/src/routes/twilio.routes.ts#L261-318) hace:


findOrgByPhoneNumber(Called)
 ‚Äî Busca en configuracion_canales qu√© organizaci√≥n tiene ese n√∫mero. Limpia el n√∫mero (quita +, espacios, guiones) y busca los √∫ltimos 10 d√≠gitos.


getDefaultAgent(organizacionId, Called)
 ‚Äî Busca el agente IA correcto, en este orden de prioridad:

‚ë† Primero busca un agente con telefono_asignado = Called Y telefono_activo = 1 Y estado = 1
‚ë° Si no hay uno asignado, busca el twilio_default_agent_id en configuracion_canales
‚ë¢ Si tampoco hay default configurado, toma el primer agente de tipo voz o hibrido que est√© activo
Registra la llamada en twilio_calls con estado ringing.

PASO 3: Backend responde con TwiML (el saludo)
El servidor responde con XML puro (TwiML). Twilio lo lee y lo ejecuta como instrucciones de voz:

xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say language="es-MX" voice="Polly.Mia">
    Hola, soy tu asistente. ¬øEn qu√© puedo ayudarte?
  </Say>
  <Gather input="speech" language="es-MX" speechTimeout="auto"
          action="/api/twilio/voice/respond?agent_id=5&org_id=2" method="POST">
    <Say language="es-MX" voice="Polly.Mia">Te escucho.</Say>
  </Gather>
  <Say language="es-MX" voice="Polly.Mia">No escuch√© nada. Adi√≥s.</Say>
  <Hangup/>
</Response>
<Say>: Twilio convierte texto a voz usando AWS Polly (voz Polly.Mia, espa√±ol M√©xico).
<Gather>: Twilio escucha al usuario. Cuando detecta silencio (speechTimeout="auto"), transcribe el audio a texto y hace otro POST al action.
Si el usuario no dice nada ‚Üí cae al <Say> de fallback y cuelga.
El greeting_message viene del agente. Si no tiene, usa personalidad o un gen√©rico: "Hola, soy {nombre}. ¬øEn qu√© puedo ayudarte?".

PASO 4: Usuario habla ‚Üí Twilio transcribe ‚Üí Backend procesa
El usuario habla. Twilio transcribe el audio con su STT (Speech-to-Text) y hace POST al endpoint de respuesta:

POST https://secretaria.click/api/twilio/voice/respond?agent_id=5&org_id=2
Content-Type: application/x-www-form-urlencoded
SpeechResult=Quiero saber su horario de atenci√≥n&Confidence=0.94&CallSid=CA123abc
El handler en [

twilio.routes.ts
 l√≠nea 396](file:///c:/callcenteria/backend/src/routes/twilio.routes.ts#L396-580) hace:

Lee el historial de la conversaci√≥n desde twilio_calls.transcript usando el CallSid.
Busca las API keys de la organizaci√≥n en configuracion_canales.
Llama a la IA (Gemini tiene prioridad sobre OpenAI):
Si tiene Gemini:
typescript
// Construye el historial multi-turno
contents = [
  { role: 'user',  parts: [{ text: 'INSTRUCCIONES DEL SISTEMA: ...' }] },
  { role: 'model', parts: [{ text: greeting }] },  // El saludo inicial
  { role: 'user',  parts: [{ text: 'turno anterior del usuario' }] },
  { role: 'model', parts: [{ text: 'respuesta anterior de la IA' }] },
  // ... historial completo ...
  { role: 'user',  parts: [{ text: SpeechResult }] }  // El mensaje actual
]
// Llama a gemini-2.0-flash con maxOutputTokens: 200, temperature: 0.7
Si tiene OpenAI (y no Gemini):
typescript
messages = [
  { role: 'system',    content: 'INSTRUCCIONES + REGLA: m√°ximo 2-3 oraciones' },
  { role: 'assistant', content: greeting },
  // ... historial ...
  { role: 'user',      content: SpeechResult }
]
// Llama a gpt-4o-mini con max_tokens: 200, temperature: 0.7
Regla de oro hardcodeada: "Solo puedes emitir UNA pregunta o respuesta por turno. M√°ximo 2-3 oraciones." ‚Äî para que la conversaci√≥n telef√≥nica sea natural.

La respuesta de la IA se limpia: se eliminan asteriscos, saltos de l√≠nea, formateo markdown (porque es audio).

Guarda el intercambio en interacciones_ia y actualiza el transcript en twilio_calls:
sql
UPDATE twilio_calls SET transcript = CONCAT(COALESCE(transcript,''), '\nUser: ', ?, '\nAI: ', ?) 
WHERE call_sid = ?
PASO 5: Backend responde con nuevo TwiML ‚Üí ciclo contin√∫a
xml
<Response>
  <Say language="es-MX" voice="Polly.Mia">[Respuesta de la IA aqu√≠]</Say>
  <Gather input="speech" language="es-MX" speechTimeout="auto"
          action="/api/twilio/voice/respond?agent_id=5&org_id=2" method="POST">
  </Gather>
  <Say language="es-MX" voice="Polly.Mia">¬øHay algo m√°s en lo que pueda ayudarte?</Say>
  <Gather input="speech" language="es-MX" speechTimeout="3" ...>
  </Gather>
  <Say language="es-MX" voice="Polly.Mia">Fue un placer atenderte. Hasta luego.</Say>
  <Hangup/>
</Response>
Este ciclo (habla ‚Üî escucha) se repite indefinidamente hasta que el usuario cuelga o hay silencio.

üìû Flujo LLAMADA SALIENTE (Click-to-Call)
El proceso es diferente: el backend inicia la llamada a trav√©s de la API REST de Twilio.

Desde el Frontend (

TestCallDialog.tsx
)
El di√°logo de prueba llama a:

POST /api/agentes-ia/:id/test-call
Body: { phone_number: "+526571234567", duration_limit: 300, notes: "..." }
El Backend hace la llamada a Twilio
C√≥digo en [

agentes-ia.routes.ts
 l√≠nea 293](file:///c:/callcenteria/backend/src/routes/agentes-ia.routes.ts#L293-389):

typescript
// Lee credenciales de la BD (sms_api_key, sms_api_secret, sms_from_number)
const twilioUrl = `https://api.twilio.com/2010-04-01/Accounts/${account_sid}/Calls.json`;
const auth = Buffer.from(`${account_sid}:${auth_token}`).toString('base64');
// El n√∫mero FROM es el de Twilio de la organizaci√≥n (sms_from_number)
// El n√∫mero TO es el que ingres√≥ el usuario en el di√°logo
formData.append('To',             phone_number);
formData.append('From',           twilioConfig.phone_number);  // ‚Üê El + de Twilio
formData.append('Url',            `${baseUrl}/api/twilio/voice/outbound?agent_id=5&org_id=2`);
formData.append('StatusCallback', `${baseUrl}/api/twilio/status`);
Twilio llama al n√∫mero de destino. Cuando contesta, Twilio hace GET/POST a la Url para pedir el TwiML.
El endpoint /voice/outbound responde con el TwiML de saludo del agente.
A partir de ah√≠, el flujo es id√©ntico al entrante: <Gather> ‚Üí /voice/respond ‚Üí IA ‚Üí repite.
üóÇÔ∏è Todos los Endpoints y Sus Roles
Endpoint	Auth	Qui√©n lo llama	Para qu√© sirve
POST /api/twilio/voice	‚ùå No (p√∫blico)	Twilio autom√°ticamente	Recibe llamadas entrantes, saluda
POST /api/twilio/voice/respond	‚ùå No (p√∫blico)	Twilio autom√°ticamente	Recibe texto del usuario, consulta IA, responde
POST /api/twilio/voice/outbound	‚ùå No (p√∫blico)	Twilio autom√°ticamente	TwiML inicial para llamadas salientes
POST /api/twilio/status	‚ùå No (p√∫blico)	Twilio autom√°ticamente	Actualiza estado/duraci√≥n de la llamada en BD
GET /api/twilio/config	‚úÖ JWT	Frontend	Lee config de Twilio (n√∫mero, agente default, URLs de webhook)
PUT /api/twilio/config	‚úÖ JWT	Frontend	Cambia el agente default de Twilio
POST /api/twilio/call	‚úÖ JWT	Frontend	Inicia llamada saliente (Click-to-Call gen√©rico)
GET /api/twilio/calls	‚úÖ JWT	Frontend	Historial de llamadas
POST /api/agentes-ia/:id/test-call	‚úÖ JWT	Frontend (

TestCallDialog
)	Llamada de prueba a un agente espec√≠fico
GET /api/agentes-ia/:id/test-calls	‚úÖ JWT	Frontend	Historial de llamadas de prueba del agente
PUT /api/settings/organizations/:id/api-keys	‚úÖ JWT	Frontend (Settings)	Guarda Account SID, Auth Token, Phone Number, Gemini Key, OpenAI Key
‚öôÔ∏è C√≥mo Se Configura en la App (UI ‚Üí BD ‚Üí Twilio)
Usuario va a Settings ‚îÄ‚îÄ> PUT /api/settings/organizations/:id/api-keys
                            ‚îÇ
                            ‚îî‚îÄ‚îÄ> BD: configuracion_canales
                                   sms_api_key    = Account SID
                                   sms_api_secret = Auth Token
                                   sms_from_number = +15551234567
                                   sms_provider   = 'twilio'
                                   gemini_api_key = AIza...
Las API keys nunca se devuelven completas ‚Äî el GET las enmascara (ACxx...xxxx). El n√∫mero de tel√©fono s√≠ se muestra completo.

üîó C√≥mo Se Conecta el Agente al N√∫mero de Tel√©fono
Hay dos mecanismos paralelos para vincular un agente a un n√∫mero:

Mecanismo 1: telefono_asignado en el agente (prioridad #1)
Desde EditVoiceAgentPage.tsx el usuario puede guardar el campo telefono_asignado en el agente. Cuando llega una llamada a ese n√∫mero, la funci√≥n 

getAgentByPhoneNumber()
 lo encuentra directamente. Si un n√∫mero ya estaba asignado a otro agente, se desasigna autom√°ticamente (solo puede haber un agente por n√∫mero).

Mecanismo 2: twilio_default_agent_id en la configuraci√≥n (prioridad #2)
Desde la pantalla de configuraci√≥n de Twilio en la app (PUT /api/twilio/config), se puede designar cu√°l agente atiende por defecto cuando ninguno tiene el n√∫mero asignado.

Mecanismo 3: Primer agente activo de voz (prioridad #3 / fallback)
Si no hay asignaci√≥n directa ni default configurado, el sistema toma el primer agente con tipo = 'voz' o 'hibrido' y estado = 1.

üèóÔ∏è C√≥mo Se Registra el Webhook en Twilio Console
Una vez el servidor est√° en una URL p√∫blica, en Twilio Console ‚Üí Phone Numbers ‚Üí Active Numbers, seleccionas tu n√∫mero y configuras:

Campo	Valor
A CALL COMES IN	Webhook
URL	https://secretaria.click/api/twilio/voice
HTTP Method	POST
Status Callback URL (opcional)	https://secretaria.click/api/twilio/status
üß© Reglas de Negocio Importantes (sin tocar nada)
Los webhooks son p√∫blicos (sin JWT) ‚Äî Twilio no puede pasar autenticaci√≥n Bearer, as√≠ que POST /voice, POST /voice/respond, POST /voice/outbound y POST /status no tienen middleware de auth.

Tiempo l√≠mite: Twilio espera m√°ximo 15 segundos de respuesta. Si el servidor tarda m√°s (IA lenta), Twilio cancela el webhook.

La respuesta DEBE ser XML TwiML v√°lido ‚Äî Si el backend devuelve JSON o error, Twilio no sabe qu√© hacer y cuelga.

La voz usada es Amazon Polly Mia (espa√±ol M√©xico, es-MX). Esto est√° hardcodeado en el TwiML generado, no es configurable desde la UI actualmente.

El modelo de Gemini es gemini-2.0-flash (hardcodeado en el c√≥digo). El modelo de OpenAI es gpt-4o-mini.

maxOutputTokens: 200 ‚Äî La respuesta de la IA est√° limitada a ~150 palabras para que suene natural por tel√©fono.

La b√∫squeda de n√∫mero es flexible: Quita +, guiones, espacios y busca por los √∫ltimos 10 d√≠gitos, lo que permite encontrar n√∫meros independientemente del formato (+15557890, 1 555 789-0, etc.).

